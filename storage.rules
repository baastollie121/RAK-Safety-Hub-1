rules_version = '2';

service firebase.storage {

  // ----------------- HELPER FUNCTIONS (TOP LEVEL) -----------------
  function isAuth() {
    return request.auth != null;
  }

  function userId() {
    return request.auth.uid;
  }

  function getUserData() {
    return firestore.get(
      /databases/(default)/documents/users/$(userId())
    ).data;
  }

  function isAdminOf(companyId) {
    return isAuth() &&
      getUserData().isAdmin == true &&
      getUserData().companyId == companyId;
  }

  function isUserInCompany(companyId) {
    return isAuth() &&
      getUserData().companyId == companyId;
  }

  match /b/{bucket}/o {

    // ALL FILES
    match /{allPaths=**} {
      allow read, write: if false; // Default: deny everything
    }

    // COMPANY-WIDE DOCUMENTS
    match /companies/{companyId}/{filePath=**} {
      // Admins can upload/download
      allow read, write: if isAdminOf(companyId);

      // Regular users can only read if they belong to the company
      allow read: if isUserInCompany(companyId);
    }

    // USER-SPECIFIC AI FILES (Grouped by email or UID)
    match /ai/{companyId}/{userEmail}/{filePath=**} {
      // Admin can access AI tools by company
      allow read, write: if isAdminOf(companyId);

      // User can only access their own AI tools
      allow read, write: if isUserInCompany(companyId) && request.auth.token.email == userEmail;
    }
  }
}